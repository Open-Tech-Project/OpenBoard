## موجز
- الهدف: تمكين اختيار التخطيطات/اللغات المفضّلة من صفحة الإعدادات وربطها بقائمة/منطق التبديل السريع باستخدام مفتاح المسافة.
- الملاحظة المنصّية: المشروع مبني على HarmonyOS/ArkUI وليس Android؛ لذلك شرط "API 19" غير منطبق مباشرة. سنوفّر مكافئًا بالتأكد من توافق التنفيذ مع إعدادات الـ SDK الحالية وبدون استخدام واجهات غير مدعومة.

## الوضع الحالي في الكود
- الإعدادات: `entry/src/main/ets/pages/SettingsPage.ets` تحتوي مفاتيح تشغيل لكل لغة وتخزّن `enabled_languages` في تفضيلات `keyboard_settings` (سطر 23–63، 75–101).
- قراءة التفضيلات: `Index.ets:onPageShow` يقرأ `enabled_languages` ويحدّث `availableLanguages` و`AppStorage` (سطر 179–215).
- التبديل السريع: سحب أفقي على زر المسافة يدوّر بين `availableLanguages` فقط (سطر 260–273، 295–301). الضغط القصير على المسافة يُدخل فراغًا (سطر 238–241).
- التخطيطات: معرفة في `KeyboardKeyData.ts`؛ اختيار بين أبجدية/رموز عبر أزرار تبديل (سطر 250–256 في `Index.ets`).

## الفروقات عن المطلوب
- يوجد منطق تفعيل/تعطيل اللغات بالفعل ويؤثر على التبديل بالسحب على المسافة.
- لا توجد "قائمة" مرئية للتبديل السريع عند استخدام المسافة؛ فقط تدوير بالسحب. سنضيف واجهة قائمة منبثقة عبر الضغط المطوّل على المسافة، تعرض اللغات المفعّلة للاختيار السريع.

## التغييرات المقترحة (تنفيذ)
1) واجهة الإعدادات لاختيار المفضّلة
- الحفاظ على مفاتيح التشغيل الحالية لكل لغة في `SettingsPage.ets` مع تحسينات بسيطة:
  - منع الحالة الفارغة: الإبقاء على حد أدنى لغة واحدة مفعّلة.
  - إبراز اللغات المفعّلة بشكل واضح بصريًا.
- عدم تغيير مسار التخزين: المفتاح `enabled_languages` داخل `keyboard_settings` كما هو.

2) قائمة التبديل السريع عبر مفتاح المسافة
- إضافة ضغط مطوّل على `SPACE_KEY` في `entry/src/main/ets/InputMethodExtensionAbility/pages/Index.ets`:
  - عند الضغط المطوّل، فتح طبقة منبثقة (Sheet/Dialog) تعرض قائمة `availableLanguages` بأسماء ودوالّ اختيار.
  - عند اختيار عنصر، تعيين `currentLanguage` مباشرة وإغلاق القائمة.
- الحفاظ على السحب الأفقي للتبديل الدوري كما هو.

3) ربط التخطيطات المختارة بالتبديل
- الاستمرار بالاعتماد على `availableLanguages` التي تُقرأ من التفضيلات في `onPageShow`.
- بعد أي تغيير تفضيلي داخل الإعدادات، ضمان تحديث `AppStorage`/إعادة مزامنة عند العودة إلى واجهة لوحة المفاتيح.

4) توافق المنطق واعتبارات المنصّة
- HarmonyOS/ArkUI: لا حاجة لتعديلات خاصة بـ Android API 19؛ سنضمن استعمال واجهات `@ohos.data.preferences` و`ArkUI` القياسية الموجودة بالفعل.
- تعزيز الحماية من فقد التفضيلات: الرجوع الافتراضي إلى `'en'` إن كانت القائمة فارغة.

5) الاختبارات الشاملة
- اختبار تفضيلات:
  - وحدات Hypium: كتابة/قراءة `enabled_languages`، التحقق من قيم الافتراضي عند الغياب.
- اختبار التبديل السريع:
  - اختبار منطق `handleSwipe(direction)` بالدوران على قائمة محددة والتأكد من تحديث `currentLanguage` الصحيح.
  - اختبار اختيار من القائمة المنبثقة: محاكاة استدعاء معالج الاختيار وتحقق من التعيين.
- توافق عبر الإصدارات:
  - تشغيل اختبارات ohosTest على المحاكي/الأجهزة المتاحة بإعدادات SDK الحالية؛ ضمان عدم استخدام واجهات غير مدعومة.

6) معالجة الأكواد القديمة وتحديثها
- توحيد المفاتيح الثابتة:
  - تعريف ثابت مشترك لمفتاح `AppStorage` الخاص باللغات لتجنّب التكرار.
- تحسين إدارة دورة الحياة:
  - التأكد من تنظيف أي مؤقتات/مستمعين عند إخفاء واجهة اللوحة.
- تحسين تسجيل الأخطاء:
  - استخدام رسائل موحّدة وإضافة سياق عند فشل القراءة/الكتابة للتفضيلات.

7) التوثيق
- إضافة تعليقات توضيحية مختصرة فوق الدوال الجديدة (القائمة المنبثقة، معالجات الضغط المطوّل، الاختبارات) توضّح الهدف والمدخلات والمخرجات.
- إبقاء التوثيق داخل الشيفرة فقط دون ملفات خارجية.

## المواقع الدقيقة للتعديل
- `entry/src/main/ets/pages/SettingsPage.ets`: تحسين عناصر Toggle وضمان الحد الأدنى المفعّل.
- `entry/src/main/ets/InputMethodExtensionAbility/pages/Index.ets`:
  - إضافة Gesture للضغط المطوّل على المسافة.
  - إضافة مكوّن ArkUI (Sheet/Dialog) لعرض قائمة `availableLanguages`.
  - معالج اختيار عنصر لتعيين `currentLanguage`.

## مخاطر وحالات حدّية
- قائمة لغات فارغة: يمنعها منطق الإعدادات ويُعوَّض بـ `'en'` عند القراءة.
- اختلاف تعرّف السحب والضغط المطوّل عبر الأجهزة: اختبار على أكثر من بيئة.
- تزامن `AppStorage`: تأكد من التحديث الفوري عند اختيار لغة من القائمة.

## التسليم والتحقق
- تنفيذ التغييرات، ثم تشغيل اختبارات Hypium وohosTest.
- التحقق يدويًا:
  - تفعيل/تعطيل لغات في الإعدادات.
  - فتح اللوحة، الضغط المطوّل على المسافة و اختيار لغة.
  - السحب للتبديل الدوري بين المفعّلة فقط.

## مراجع للشيفرة الحالية
- خدمة IME: `entry/src/main/ets/InputMethodExtensionAbility/InputMethodService.ts:6–13`
- تحكّم اللوحة: `entry/src/main/ets/InputMethodExtensionAbility/model/KeyboardController.ts:47–178, 105–154`
- صفحة اللوحة: `entry/src/main/ets/InputMethodExtensionAbility/pages/Index.ets:88–99, 179–215, 238–273, 295–301, 473–488`
- الإعدادات/التفضيلات: `entry/src/main/ets/pages/SettingsPage.ets:23–63, 75–101`
- التخطيطات والبيانات: `entry/src/main/ets/InputMethodExtensionAbility/model/KeyboardKeyData.ts:1–289`

## طلب الموافقة
- إن وافقت على الخطة، أبدأ مباشرة بتنفيذها: إضافة القائمة المنبثقة للضغط المطوّل على المسافة، تعزيز الإعدادات، وتهيئة الاختبارات. ثم أقدّم لك التغييرات للمراجعة قبل أي التزام نهائي.